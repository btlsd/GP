<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <title>군포 프로젝트</title>
  <style>
    body { font-family: sans-serif; background:#111; color:#eee; }
    pre  { background:#222; padding:10px; height:400px; overflow:auto; }
    button { margin-top:10px; }
    .proper-noun { color:#0ff; }
  </style>
</head>
<body>
  <h1>군포 프로젝트</h1>
  <pre id="output"></pre>
  <button id="start">게임 시작</button>

  <script type="module">
    // Pyodide 모듈을 불러와 브라우저에서 Python 코드를 실행하고
    // 텍스트 기반 게임을 구동하는 스크립트이다.
    import { loadPyodide } from "https://cdn.jsdelivr.net/pyodide/v0.24.1/full/pyodide.mjs";

    // 출력 영역과 시작 버튼 요소 참조
    const output = document.getElementById("output");
    const startBtn = document.getElementById("start");
    let pyodide = null;   // Pyodide 인스턴스 저장
    let htmlBuffer = "";  // 출력 내용을 누적하여 표시

    // 에러 객체를 사람이 읽기 쉬운 문자열로 변환
    function formatError(err) {
      const code = err?.code || err?.name || "UnknownError";
      const message = err?.message || err;
      return `[${code}] ${message}`;
    }

    // 일정 시간(ms) 대기
    function sleep(ms) {
      return new Promise((resolve) => setTimeout(resolve, ms));
    }

    // 강조할 고유명사 목록
    const properNouns = { "군포": "proper-noun" };

    // 문자열 내의 특정 단어를 색상으로 강조
    function colorProperNouns(text) {
      for (const [word, cls] of Object.entries(properNouns)) {
        const spanRegex = new RegExp(`<span class="${cls}">(.*?)<\/span>`, "g");
        text = text.replace(spanRegex, "$1");
        const wordRegex = new RegExp(word, "g");
        text = text.replace(wordRegex, `<span class="${cls}">${word}</span>`);
      }
      return text;
    }

    // 브라우저에서 HTML을 안전하게 출력하기 위한 이스케이프 함수
    function escapeHtml(str) {
      return str
        .replace(/&/g, "&amp;")
        .replace(/</g, "&lt;")
        .replace(/>/g, "&gt;");
    }

    // 한 줄의 텍스트를 타자 치듯이 출력
    async function typeLine(line) {
      for (const ch of line) {
        htmlBuffer += ch;
        output.innerHTML = colorProperNouns(htmlBuffer);
        output.scrollTop = output.scrollHeight;
        await sleep(50);
      }
      htmlBuffer += "<br>";
      output.innerHTML = colorProperNouns(htmlBuffer);
      output.scrollTop = output.scrollHeight;
    }

    // Python의 print 출력을 오프닝과 동일하게 표시하기 위한 대기열
    const printQueue = [];
    let printing = false;

    async function processPrintQueue() {
      if (printing) return; // 이미 처리 중이면 중복 실행 방지
      printing = true;
      while (printQueue.length > 0) {
        const text = printQueue.shift();
        const lines = text.split(/\n/);
        for (const line of lines) {
          if (line) {
            await typeLine(line);
          } else {
            htmlBuffer += "<br>";
            output.innerHTML = colorProperNouns(htmlBuffer);
            output.scrollTop = output.scrollHeight;
          }
        }
      }
      printing = false;
    }

    // 오프닝 텍스트를 순차적으로 출력
    async function playOpening() {
      try {
        const res = await fetch("opening.json");
        const lines = await res.json();
        for (const line of lines) {
          await typeLine(line);
          await sleep(400);
        }
    } catch (err) {
      htmlBuffer += `[오프닝 로드 실패]<br>${formatError(err)}<br>`;
      output.innerHTML = colorProperNouns(htmlBuffer);
    }
  }

  // Pyodide 파일 시스템에 필요한 JSON 파일들을 미리 로드
  async function preloadFiles() {
    const files = ["config.json", "actions.json", "tutorial.json", "player.json", "save.json"];
    for (const file of files) {
      try {
        const res = await fetch(file);
        if (!res.ok) continue;
        const text = await res.text();
        pyodide.FS.writeFile(`/home/pyodide/${file}`, new TextEncoder().encode(text));
      } catch (err) {
        output.innerHTML += `<br>[파일 로드 실패] ${file}<br>${formatError(err)}<br>`;
      }
    }
  }

  // Pyodide 초기화 및 브라우저에 출력 함수를 연결
  async function initPyodide() {
    try {
      pyodide = await loadPyodide();
      pyodide.registerJsModule("browser", {
          write: (text) => {
            // Python에서 온 출력을 HTML로 안전하게 변환 후 큐에 추가
            printQueue.push(escapeHtml(text));
            processPrintQueue();
          }
        });
      } catch (err) {
        output.textContent += `Pyodide 초기화 실패:\n${formatError(err)}\n`;
      }
    }
    initPyodide();


      // 시작 버튼을 눌렀을 때 게임 코드 실행
      startBtn.addEventListener("click", async () => {
        output.innerHTML = colorProperNouns("=== 군포 프로젝트 ===<br>");
        htmlBuffer = output.innerHTML;
        startBtn.disabled = true;

        if (!pyodide) {
          output.innerHTML += "<br>[오류] Pyodide가 아직 초기화되지 않았습니다.<br>";
          startBtn.disabled = false;
          return;
        }

        await playOpening();

        try {
          await preloadFiles();          // 게임에 필요한 데이터 로드
          const gameCode = await (await fetch("game.py")).text();
          await pyodide.runPythonAsync(gameCode);  // Python 코드 실행
        } catch (err) {
          output.innerHTML += `<br>[에러 발생]<br>${formatError(err)}<br>`;
        }

        startBtn.disabled = false;
      });
  </script>
</body>
</html>
