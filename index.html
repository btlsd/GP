<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <title>군포 프로젝트</title>
  <style>
    body { font-family: sans-serif; background:#111; color:#eee; }
    pre  { background:#222; padding:10px; height:400px; overflow:auto; }
    button { margin-top:10px; }
    .proper-noun { color:#0ff; }
  </style>
</head>
<body>
  <h1>군포 프로젝트</h1>
  <pre id="output"></pre>
  <button id="start">게임 시작</button>

  <script type="module">
    import { loadPyodide } from "https://cdn.jsdelivr.net/pyodide/v0.24.1/full/pyodide.mjs";

    const output = document.getElementById("output");
    const startBtn = document.getElementById("start");
    let pyodide = null;
    let htmlBuffer = "";

    function formatError(err) {
      const code = err?.code || err?.name || "UnknownError";
      const message = err?.message || err;
      return `[${code}] ${message}`;
    }

    function sleep(ms) {
      return new Promise((resolve) => setTimeout(resolve, ms));
    }

    const properNouns = { "군포": "proper-noun" };

    function colorProperNouns(text) {
      for (const [word, cls] of Object.entries(properNouns)) {
        const spanRegex = new RegExp(`<span class="${cls}">(.*?)<\/span>`, "g");
        text = text.replace(spanRegex, "$1");
        const wordRegex = new RegExp(word, "g");
        text = text.replace(wordRegex, `<span class="${cls}">${word}</span>`);
      }
      return text;
    }

    function escapeHtml(str) {
      return str
        .replace(/&/g, "&amp;")
        .replace(/</g, "&lt;")
        .replace(/>/g, "&gt;");
    }

    async function typeLine(line) {
      for (const ch of line) {
        htmlBuffer += ch;
        output.innerHTML = colorProperNouns(htmlBuffer);
        await sleep(50);
      }
      htmlBuffer += "<br>";
      output.innerHTML = colorProperNouns(htmlBuffer);
    }

    async function playOpening() {
      try {
        const res = await fetch("opening.json");
        const lines = await res.json();
        for (const line of lines) {
          await typeLine(line);
          await sleep(400);
        }
    } catch (err) {
      htmlBuffer += `[오프닝 로드 실패]<br>${formatError(err)}<br>`;
      output.innerHTML = colorProperNouns(htmlBuffer);
    }
  }

  async function preloadFiles() {
    const files = ["config.json", "actions.json", "tutorial.json", "player.json", "save.json"];
    for (const file of files) {
      try {
        const res = await fetch(file);
        if (!res.ok) continue;
        const text = await res.text();
        pyodide.FS.writeFile(`/home/pyodide/${file}`, new TextEncoder().encode(text));
      } catch (err) {
        output.innerHTML += `<br>[파일 로드 실패] ${file}<br>${formatError(err)}<br>`;
      }
    }
  }

  async function initPyodide() {
    try {
      pyodide = await loadPyodide();
      pyodide.registerJsModule("browser", {
          write: (text) => {
            const escaped = escapeHtml(text).replace(/\n/g, "<br>");
            output.innerHTML += colorProperNouns(escaped);
          }
        });
      } catch (err) {
        output.textContent += `Pyodide 초기화 실패:\n${formatError(err)}\n`;
      }
    }
    initPyodide();


      startBtn.addEventListener("click", async () => {
        output.innerHTML = colorProperNouns("=== 군포 프로젝트 ===<br>");
        htmlBuffer = output.innerHTML;
        startBtn.disabled = true;

        if (!pyodide) {
          output.innerHTML += "<br>[오류] Pyodide가 아직 초기화되지 않았습니다.<br>";
          startBtn.disabled = false;
          return;
        }

        await playOpening();

        try {
          await preloadFiles();
          const gameCode = await (await fetch("game.py")).text();
          await pyodide.runPythonAsync(gameCode);
        } catch (err) {
          output.innerHTML += `<br>[에러 발생]<br>${formatError(err)}<br>`;
        }

        startBtn.disabled = false;
      });
  </script>
</body>
</html>
